<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | Current+ Enterprise ESG Analytics Platform</title>
  
  <!-- ThingSpeak Error Handler - Load first to catch any errors -->
  <script src="js/thingspeak-error-handler.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Custom Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              100: '#E6F7FF',
              200: '#BAE7FF',
              300: '#91D5FF',
              400: '#69C0FF',
              500: '#40A9FF',
              600: '#1890FF',
              700: '#096DD9',
              800: '#0050B3',
              900: '#003A8C',
            },
            secondary: {
              500: '#722ED1',
            },
            dark: {
              800: '#1F2937',
              900: '#111827',
            },
            success: {
              500: '#52C41A',
              600: '#389E0D',
            },
            warning: {
              500: '#FAAD14',
            },
            danger: {
              500: '#F5222D',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <!-- Use style.css as the main stylesheet -->
  <link rel="stylesheet" href="css/style.css">
  <!-- Also include the compatibility file to support both naming conventions -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Preload fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Load dependencies coordinator before any other script -->
  <script src="js/loader.js"></script>
  
  <!-- Our application scripts (will run after dependencies are loaded) -->
  <script src="js/thingspeak-helper.js" defer></script>
  <script src="js/main.js" defer></script>
  <script src="js/charts.js" defer></script>
  <script src="js/ai-model.js" defer></script>
  <script src="js/report-generator.js" defer></script>
  <!-- Load DOM safety utility first -->
  <script src="js/dom-safe.js" defer></script>
  <!-- Then load ThingSpeak helper -->
  <script src="js/thingspeak-helper.js" defer></script>
  <!-- Load main app scripts -->
  <script src="js/main.js" defer></script>
  <script src="js/settings.js" defer></script>
</head>
<body class="bg-dark-900 text-white font-sans min-h-screen" id="settings-page-identifier">
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:p-4 focus:bg-primary-600 focus:text-white">Skip to main content</a>

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 border-r border-gray-700 bg-dark-800 hidden md:block">
      <div class="p-6">
        <div class="flex items-center space-x-3">
          <div class="bg-primary-600 rounded-md p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold">Current<span class="text-primary-500">+</span></h1>
        </div>
      </div>
      <nav class="px-4 py-4 space-y-1">
        <a href="index.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-gauge-high w-5 h-5 mr-3"></i>
          <span>Dashboard</span>
        </a>
        <a href="reports.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-file-lines w-5 h-5 mr-3"></i>
          <span>Reports</span>
        </a>
        <a href="ai-predictions.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-brain w-5 h-5 mr-3"></i>
          <span>AI Predictions</span>
        </a>
        <a href="analytics.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-chart-simple w-5 h-5 mr-3"></i>
          <span>Analytics</span>
        </a>
        <a href="settings.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-gear w-5 h-5 mr-3"></i>
          <span>Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 overflow-y-auto">
      <!-- Top navigation -->
      <header class="bg-dark-800 shadow-md border-b border-gray-700">
        <div class="flex items-center justify-between px-6 py-4">
          <div class="flex items-center">
            <button id="settings-mobile-menu-toggle" class="text-gray-400 hover:text-white md:hidden" aria-label="Toggle mobile menu" title="Toggle mobile menu">
              <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <h2 class="text-xl font-semibold ml-4 md:ml-0">Settings</h2>
          </div>
          <div class="flex items-center space-x-4">
            <div class="save-indicator hidden md:flex" id="save-indicator">
              <i class="fas fa-clock mr-1.5"></i>
              <span>Last saved: <span id="last-saved-time">Never</span></span>
            </div>
            <button id="save-settings" class="text-white bg-primary-600 hover:bg-primary-700 px-4 py-2 rounded-md text-sm font-medium transition-all duration-300 transform hover:scale-105 flex items-center" onclick="saveSettingsDirectly()">
              <i class="fa-solid fa-floppy-disk mr-2"></i>
              Save Settings
            </button>
            <div class="h-8 w-8 rounded-full bg-primary-600 flex items-center justify-center text-white">
              <span class="font-medium text-sm">AC</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Page content -->
      <div class="p-6">
        <!-- Page title -->
        <div class="mb-8">
          <h1 class="text-2xl font-bold">Platform Settings</h1>
          <p class="text-gray-400 mt-1">Configure the Current+ Enterprise ESG Analytics Platform</p>
        </div>

        <!-- Debug message (hidden by default) -->
        <div id="debug-message" class="mb-5 p-3 bg-dark-700 border border-gray-600 rounded-md text-gray-300 text-sm hidden">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold">Debug Information</h3>
              <p id="debug-content" class="mt-1">No debug information available</p>
            </div>
            <button id="close-debug" class="text-gray-400 hover:text-white" title="Close debug information">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Settings sections -->
        <div class="space-y-8">
          <!-- API Configuration Section -->
          <div class="bg-dark-800 rounded-xl border border-gray-700 shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
            <div class="space-y-4">
              <div class="mb-4">
                <label for="thingspeak-channel" class="block text-gray-300 font-medium mb-2">ThingSpeak Channel ID</label>
                <div class="flex space-x-2">
                  <input type="text" id="thingspeak-channel" name="thingspeak-channel" 
                         class="thingspeak-input w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
              </div>
              
              <div class="mb-4">
                <label for="thingspeak-api-key" class="block text-gray-300 font-medium mb-2">ThingSpeak API Key</label>
                <div class="flex space-x-2">
                  <input type="text" id="thingspeak-api-key" name="thingspeak-api-key" 
                         class="thingspeak-input w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                  </div>
                  </div>
              
              <div class="mb-6">
                <button id="test-connection" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <i class="fas fa-plug mr-2"></i> Test Connection
                </button>
                <span id="connection-status" class="ml-3 text-sm"></span>
                  </div>
              
                  <div>
                <label for="refresh-interval" class="block text-sm font-medium text-gray-300 mb-1">Data Refresh Interval (seconds)</label>
                <input type="number" id="refresh-interval" class="w-full rounded-md px-4 py-2" value="30" min="10" max="3600">
                  </div>
              
              <div class="flex items-center">
                <label for="auto-refresh" class="toggle-switch mr-3">
                  <input type="checkbox" id="auto-refresh" checked title="Enable auto-refresh of data">
                  <span class="toggle-slider"></span>
                </label>
                <label for="auto-refresh" class="text-sm font-medium text-gray-300 cursor-pointer">Enable Auto-Refresh</label>
                </div>
              </div>
            </div>

          <!-- PowerBI Integration Settings -->
          <div class="bg-dark-800 rounded-xl border border-gray-700 shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">PowerBI Integration</h2>
              <div class="space-y-4">
                  <div class="flex items-center">
                <label for="powerbi-integration" class="toggle-switch mr-3">
                  <input type="checkbox" id="powerbi-integration" checked title="Enable PowerBI integration">
                  <span class="toggle-slider"></span>
                </label>
                <label for="powerbi-integration" class="text-sm font-medium text-gray-300 cursor-pointer">Enable PowerBI Integration</label>
                    </div>
              
                    <div>
                <label for="powerbi-workspace" class="block text-sm font-medium text-gray-400 mb-1">PowerBI Workspace ID (optional)</label>
                <input type="text" id="powerbi-workspace" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Enter workspace ID for direct integration">
                    </div>
              
              <div>
                <label for="powerbi-template" class="block text-sm font-medium text-gray-400 mb-1">PowerBI Template URL</label>
                <input type="text" id="powerbi-template" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500" value="https://current-plus.example.com/templates/esg-dashboard.pbit">
                </div>
                
                  <div class="flex items-center">
                <label for="powerbi-auto-export" class="toggle-switch mr-3">
                  <input type="checkbox" id="powerbi-auto-export" checked title="Enable weekly automatic export to PowerBI">
                  <span class="toggle-slider"></span>
                </label>
                <label for="powerbi-auto-export" class="text-sm font-medium text-gray-300 cursor-pointer">Enable Weekly Automatic Export</label>
              </div>
              
              <div class="bg-primary-600/10 border-l-4 border-primary-600 p-4 rounded-r-md mt-4">
                <h4 class="text-sm font-medium text-primary-400">PowerBI Template</h4>
                <p class="text-xs text-gray-400 mt-1">Download our pre-configured PowerBI template for enhanced visualization of your ESG data. The template includes custom dashboards and reports designed specifically for ESG analytics.</p>
                <button class="mt-2 inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                  <i class="fas fa-download mr-1"></i> Download Template
              </button>
            </div>
          </div>
                  </div>
                  
          <!-- Report Generation Settings -->
          <div class="bg-dark-800 rounded-xl border border-gray-700 shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Report Settings</h2>
            <div class="space-y-4">
                  <div>
                <label for="company-name" class="block text-sm font-medium text-gray-400 mb-1">Company Name</label>
                <input type="text" id="company-name" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500" value="Your Organization">
                  </div>
                  
                  <div>
                <label for="carbon-factor" class="block text-sm font-medium text-gray-400 mb-1">Carbon Emission Factor (kg CO₂/kWh)</label>
                <input type="number" id="carbon-factor" step="0.01" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500" value="0.71">
                <p class="text-xs text-gray-500 mt-1">Standard factor varies by location and energy mix. US average is 0.71 kg CO₂/kWh.</p>
                  </div>
                  
              <div class="flex items-center">
                <label for="include-ai-predictions" class="toggle-switch mr-3">
                  <input type="checkbox" id="include-ai-predictions" checked title="Include AI predictions in generated reports">
                  <span class="toggle-slider"></span>
                    </label>
                <label for="include-ai-predictions" class="text-sm font-medium text-gray-300 cursor-pointer">Include AI Predictions in Reports</label>
                  </div>
                  
              <div class="flex items-center">
                <label for="include-powerbi-section" class="toggle-switch mr-3">
                  <input type="checkbox" id="include-powerbi-section" checked title="Include PowerBI section in generated reports">
                  <span class="toggle-slider"></span>
                    </label>
                <label for="include-powerbi-section" class="text-sm font-medium text-gray-300 cursor-pointer">Include PowerBI Section in Reports</label>
                  </div>
                  
                  <div>
                <label for="report-logo" class="block text-sm font-medium text-gray-400 mb-1">Company Logo URL</label>
                <input type="text" id="report-logo" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="https://your-company.com/logo.png">
                  </div>
                </div>
                </div>
                
          <!-- AI Configuration Settings -->
          <div class="bg-dark-800 rounded-xl border border-gray-700 shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">AI Configuration</h2>
              <div class="space-y-4">
              <div class="flex items-center">
                <label for="enable-ai" class="toggle-switch mr-3">
                  <input type="checkbox" id="enable-ai" checked title="Enable AI predictions functionality">
                  <span class="toggle-slider"></span>
                    </label>
                <label for="enable-ai" class="text-sm font-medium text-gray-300 cursor-pointer">Enable AI Predictions</label>
                </div>
                
                  <div>
                <label for="prediction-horizon" class="block text-sm font-medium text-gray-400 mb-1">Prediction Horizon (days)</label>
                <select id="prediction-horizon" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                  <option value="7">7 days</option>
                  <option value="14">14 days</option>
                  <option value="30" selected>30 days</option>
                  <option value="90">90 days</option>
                </select>
                  </div>
              
                  <div>
                <label for="ai-model-version" class="block text-sm font-medium text-gray-400 mb-1">AI Model Version</label>
                <select id="ai-model-version" class="w-full bg-dark-800 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                  <option value="standard" selected>Standard (Default)</option>
                  <option value="advanced">Advanced (Requires more data)</option>
                  <option value="lightweight">Lightweight (Faster performance)</option>
                </select>
                </div>
                
                  <div>
                <label for="ai-confidence" class="block text-sm font-medium text-gray-400 mb-1">AI Confidence Threshold (%)</label>
                <input type="range" id="ai-confidence" class="w-full h-2 bg-dark-800 rounded-lg appearance-none cursor-pointer" min="70" max="95" value="85">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>Less strict (70%)</span>
                  <span id="confidence-value">85%</span>
                  <span>More strict (95%)</span>
                  </div>
              </div>
                  </div>
                </div>
                
          <!-- System Information -->
          <div class="bg-dark-800 rounded-xl border border-gray-700 shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">System Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                <p class="text-gray-400">Platform Version</p>
                <p class="font-medium">1.2.5</p>
                  </div>
                  <div>
                <p class="text-gray-400">Last Data Refresh</p>
                <p class="font-medium" id="last-data-refresh">2023-08-15 14:22:35</p>
                  </div>
                  <div>
                <p class="text-gray-400">Storage Status</p>
                <p class="font-medium"><span id="storage-status">Checking...</span></p>
                  </div>
                  <div>
                <p class="text-gray-400">Data Storage</p>
                <p class="font-medium">Local Browser Storage</p>
                  </div>
                </div>
            <div class="mt-4 flex flex-wrap gap-3">
              <button id="clear-data-btn" class="inline-flex items-center px-4 py-2 bg-dark-700 hover:bg-danger-500 text-white rounded-md shadow-sm text-sm font-medium transition-colors duration-300">
                <i class="fas fa-trash-can mr-2"></i>
                Clear Local Data
              </button>
              <button id="export-all-data-btn" class="inline-flex items-center px-4 py-2 bg-dark-700 hover:bg-dark-600 text-white rounded-md shadow-sm text-sm font-medium transition-colors duration-300">
                <i class="fas fa-file-export mr-2"></i>
                Export All Data
              </button>
              <button id="test-localstorage-btn" class="inline-flex items-center px-4 py-2 bg-dark-700 hover:bg-primary-600 text-white rounded-md shadow-sm text-sm font-medium transition-colors duration-300">
                <i class="fas fa-vial mr-2"></i>
                Test Storage
              </button>
              </div>
            </div>

          <!-- ThingSpeak Debug Tool - NEW SECTION -->
          <div class="bg-dark-800 rounded-xl border border-gray-700 shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ThingSpeak Debug Tool</h2>
            <p class="text-gray-400 text-sm mb-4">Use this tool to diagnose connection issues with ThingSpeak API.</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                <h3 class="text-md font-medium mb-3">Direct ThingSpeak Test</h3>
                  <div class="space-y-3">
                    <div>
                    <label class="block text-sm text-gray-400 mb-1">Channel ID</label>
                    <input type="text" id="debug-channel-id" class="w-full bg-dark-900 border border-gray-600 rounded-md px-3 py-2 text-white text-sm" placeholder="e.g., 12345">
                    </div>
                    <div>
                    <label class="block text-sm text-gray-400 mb-1">API Key</label>
                    <input type="text" id="debug-api-key" class="w-full bg-dark-900 border border-gray-600 rounded-md px-3 py-2 text-white text-sm" placeholder="Your ThingSpeak Read API Key">
                    </div>
                    <div>
                    <label for="debug-results" class="block text-sm text-gray-400 mb-1">Results to fetch</label>
                    <input type="number" id="debug-results" name="debug-results" class="w-full bg-dark-900 border border-gray-600 rounded-md px-3 py-2 text-white text-sm" value="1" min="1" max="8000" aria-label="Number of results to fetch from ThingSpeak" placeholder="Enter number of results to fetch (1-8000)">
                    </div>
                  <div class="flex space-x-2">
                    <button id="test-thingspeak-direct" class="inline-flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium">
                      <i class="fas fa-plug mr-2"></i>
                      Test Direct Connection
                    </button>
                    <button id="test-thingspeak-proxy" class="inline-flex items-center px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-sm font-medium">
                      <i class="fas fa-exchange-alt mr-2"></i>
                      Test via Proxy
                      </button>
                    </div>
                  </div>
                </div>
                
              <div>
                <h3 class="text-md font-medium mb-3">Results</h3>
                <div id="debug-results-container" class="bg-dark-900 border border-gray-700 rounded-md p-3 h-48 overflow-y-auto">
                  <div class="text-gray-400 text-sm">Results will appear here...</div>
                </div>
              </div>
            </div>
            
            <div class="mt-6">
              <h3 class="text-md font-medium mb-3">Test Channel Examples</h3>
              <p class="text-gray-400 text-sm mb-2">These are public test channels you can use to verify your connection:</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="bg-dark-900 rounded-md p-3 border border-gray-700">
                  <p class="font-medium">Demo Weather Station</p>
                  <p class="text-gray-400">Channel ID: <span class="text-blue-400">12397</span></p>
                  <p class="text-gray-400">API Key: <span class="text-blue-400">JMZCM47SV93DPC0R</span></p>
                  <button class="use-example-channel mt-2 text-xs px-2 py-1 bg-blue-900 hover:bg-blue-800 text-white rounded" 
                          data-channel="12397" data-key="JMZCM47SV93DPC0R">
                    Use This Example
                    </button>
                  </div>
                <div class="bg-dark-900 rounded-md p-3 border border-gray-700">
                  <p class="font-medium">IoT Plant Monitor</p>
                  <p class="text-gray-400">Channel ID: <span class="text-blue-400">758756</span></p>
                  <p class="text-gray-400">API Key: <span class="text-blue-400">UOB96RP9ZPUSZHTS</span></p>
                  <button class="use-example-channel mt-2 text-xs px-2 py-1 bg-blue-900 hover:bg-blue-800 text-white rounded" 
                          data-channel="758756" data-key="UOB96RP9ZPUSZHTS">
                    Use This Example
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="bg-dark-800 border-t border-gray-700 px-6 py-4 mt-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="text-gray-400 text-sm">
            © 2023 Current+ Enterprise ESG Analytics Platform
          </div>
          <div class="mt-2 md:mt-0 text-gray-500 text-xs">
            Data powered by ThingSpeak | AI Predictions by TensorFlow.js
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Mobile sidebar toggle -->
  <div class="md:hidden fixed bottom-4 right-4 z-50">
    <button id="mobile-menu-toggle" class="p-3 rounded-full bg-primary-600 text-white shadow-lg" aria-label="Toggle menu" title="Toggle menu">
      <i class="fa-solid fa-bars"></i>
    </button>
  </div>

  <!-- Mobile menu (off-canvas) -->
  <div id="mobile-menu" class="fixed inset-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="mobile-menu-overlay"></div>
    <div class="absolute inset-y-0 left-0 w-64 bg-dark-800 shadow-xl transform transition-transform duration-300 ease-in-out">
      <!-- Mobile menu content -->
      <div class="p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="bg-primary-600 rounded-md p-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <h1 class="text-2xl font-bold text-white">Current<span class="text-primary-500">+</span></h1>
          </div>
          <button id="close-mobile-menu" class="text-gray-400 hover:text-white" title="Close menu">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>
      </div>
      <nav class="px-4 py-4 space-y-1">
        <a href="index.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-gauge-high w-5 h-5 mr-3"></i>
          <span>Dashboard</span>
        </a>
        <a href="reports.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-file-lines w-5 h-5 mr-3"></i>
          <span>Reports</span>
        </a>
        <a href="ai-predictions.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-brain w-5 h-5 mr-3"></i>
          <span>AI Predictions</span>
        </a>
        <a href="analytics.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-chart-simple w-5 h-5 mr-3"></i>
          <span>Analytics</span>
        </a>
        <a href="settings.html" class="flex items-center px-4 py-3 text-gray-300 rounded-lg bg-gray-700 group transition-colors duration-200 ease-in-out">
          <i class="fa-solid fa-gear w-5 h-5 mr-3"></i>
          <span>Settings</span>
        </a>
      </nav>
    </div>
  </div>

  <!-- Success Notification -->
  <div id="success-notification" class="fixed top-4 right-4 flex items-center bg-green-900 text-green-100 px-4 py-3 rounded-md shadow-lg z-50 hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </svg>
    <span id="notification-text">Settings saved successfully!</span>
  </div>
  
  <!-- Error Notification -->
  <div id="error-notification" class="fixed top-4 right-4 flex items-center bg-red-900 text-red-100 px-4 py-3 rounded-md shadow-lg z-50 hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
      </svg>
    <span id="error-text">An error occurred. Please try again.</span>
  </div>
  
  <!-- Loading Indicator -->
  <div id="loading-indicator" class="fixed inset-0 bg-dark-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-dark-800 rounded-lg p-6 max-w-sm flex items-center space-x-4">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-500"></div>
      <p id="loading-text" class="text-white">Loading...</p>
    </div>
  </div>

  <!-- Add this before the closing body tag -->
  <script>
    // Utility functions for loading and notifications
    function showLoading(text = 'Loading...') {
      try {
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        
        if (!loadingIndicator) {
          console.warn('Loading indicator element not found');
          return;
        }
        
        if (loadingText) {
          loadingText.textContent = text;
        }
        
        // Use classList?.remove to prevent errors if classList is undefined
        loadingIndicator.classList?.remove('hidden');
      } catch (error) {
        console.error('Error in showLoading:', error);
      }
    }
    
    function hideLoading() {
      try {
        const loadingIndicator = document.getElementById('loading-indicator');
        if (!loadingIndicator) {
          console.warn('Loading indicator element not found');
          return;
        }
        
        // Use classList?.add to prevent errors if classList is undefined
        loadingIndicator.classList?.add('hidden');
      } catch (error) {
        console.error('Error in hideLoading:', error);
      }
    }
    
    function showError(message) {
      try {
        console.error(message);
        
        const notification = document.getElementById('error-notification');
        const errorText = document.getElementById('error-text');
        
        if (!notification) {
          console.warn('Error notification element not found');
          return;
        }
        
        if (errorText) {
          errorText.textContent = message;
        }
        
        // Use classList?.remove to prevent errors if classList is undefined
        notification.classList?.remove('hidden');
        
        // Hide after 5 seconds
        setTimeout(() => {
          // Check if element still exists before trying to hide it
          const notificationCheck = document.getElementById('error-notification');
          if (notificationCheck) {
            notificationCheck.classList?.add('hidden');
          }
        }, 5000);
      } catch (error) {
        console.error('Error in showError:', error);
      }
    }
    
    function showSuccessMessage(message) {
      try {
        const notification = document.getElementById('success-notification');
        const notificationText = document.getElementById('notification-text');
        
        if (!notification) {
          console.warn('Success notification element not found');
          return;
        }
        
        if (notificationText) {
          notificationText.textContent = message;
        }
        
        // Use classList?.remove to prevent errors if classList is undefined
        notification.classList?.remove('hidden');
        
        // Hide after 3 seconds
        setTimeout(() => {
          // Check if element still exists before trying to hide it
          const notificationCheck = document.getElementById('success-notification');
          if (notificationCheck) {
            notificationCheck.classList?.add('hidden');
          }
        }, 3000);
      } catch (error) {
        console.error('Error in showSuccessMessage:', error);
      }
    }
    
    // Direct save function implementation
    function saveSettingsDirectly() {
      try {
        console.log("saveSettingsDirectly called");
        
        // Show saving indicator
        const saveButton = document.getElementById('save-settings');
        const saveIndicator = document.getElementById('save-indicator');
        
        showLoading('Saving settings...');
        
        if (saveButton) {
          saveButton.disabled = true;
          saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
        }
        
        if (saveIndicator) {
          saveIndicator.classList?.remove('hidden');
          saveIndicator.innerHTML = '<i class="fas fa-spinner fa-spin mr-1.5"></i> Saving...';
        }
        
        try {
          // Get all settings values
          const channelID = document.getElementById('thingspeak-channel')?.value || '';
          const apiKey = document.getElementById('thingspeak-api-key')?.value || '';
          const refreshInterval = document.getElementById('refresh-interval')?.value || '30';
          const autoRefresh = document.getElementById('auto-refresh')?.checked || false;
          
          // PowerBI settings
          const powerbiEnabled = document.getElementById('powerbi-integration')?.checked || false;
          const powerbiWorkspace = document.getElementById('powerbi-workspace')?.value || '';
          const powerbiTemplate = document.getElementById('powerbi-template')?.value || '';
          const powerbiAutoExport = document.getElementById('powerbi-auto-export')?.checked || false;
          
          // Save to localStorage
          localStorage.setItem('thingspeakChannelID', channelID);
          localStorage.setItem('thingspeakAPIKey', apiKey);
          localStorage.setItem('refreshInterval', refreshInterval);
          localStorage.setItem('autoRefresh', String(autoRefresh));
          localStorage.setItem('powerbiEnabled', String(powerbiEnabled));
          localStorage.setItem('powerbiWorkspace', powerbiWorkspace);
          localStorage.setItem('powerbiTemplate', powerbiTemplate);
          localStorage.setItem('powerbiAutoExport', String(powerbiAutoExport));
          
          // Save timestamp
          const now = new Date();
          localStorage.setItem('lastSavedTime', now.toISOString());
          
          // Show success message
          hideLoading();
          showSuccessMessage("Settings saved successfully!");
          
          // Reset button and update indicator
          setTimeout(() => {
            if (saveButton) {
              saveButton.disabled = false;
              saveButton.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i> Save Settings';
            }
            
            if (saveIndicator) {
              saveIndicator.innerHTML = '<i class="fas fa-check-circle mr-1.5 text-green-500"></i> <span>Last saved: <span id="last-saved-time">' + now.toLocaleString() + '</span></span>';
            }
          }, 1000);
          
          console.log("Settings saved successfully");
          return true;
        } catch (error) {
          console.error("Error saving settings:", error);
          
          // Hide loading and show error
          hideLoading();
          showError("Failed to save settings: " + error.message);
          
          // Reset button
          if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i> Save Settings';
          }
          
          if (saveIndicator) {
            saveIndicator.innerHTML = '<i class="fas fa-times-circle mr-1.5 text-red-500"></i> Save failed';
          }
          
          return false;
        }
      } catch (outerError) {
        console.error("Critical error in saveSettingsDirectly:", outerError);
        alert("An error occurred while saving settings. Please check the console for details.");
        return false;
      }
    }

    // Inline script to check local storage functionality
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Direct save button binding to ensure it works
        const saveButton = document.getElementById('save-settings');
        if (saveButton) {
          console.log("Found save button, adding direct event listener");
          saveButton.addEventListener('click', saveSettingsDirectly);
        } else {
          console.error("Save settings button not found!");
        }
        
        // Check localStorage availability
        function checkLocalStorage() {
          const storageStatus = document.getElementById('storage-status');
          if (!storageStatus) {
            console.warn('Storage status element not found');
            return;
          }
          
          try {
            const testKey = 'current_plus_test';
            localStorage.setItem(testKey, 'test');
            const testValue = localStorage.getItem(testKey);
            localStorage.removeItem(testKey);
            
            if (testValue === 'test') {
              storageStatus.textContent = 'Available';
              storageStatus.className = 'text-green-500';
            } else {
              storageStatus.textContent = 'Error: Test failed';
              storageStatus.className = 'text-red-500';
            }
          } catch (e) {
            storageStatus.textContent = 'Not Available';
            storageStatus.className = 'text-red-500';
            showDebugMessage('LocalStorage Error: ' + e.message);
          }
        }
        
        // Show debug message
        function showDebugMessage(message) {
          const debugBox = document.getElementById('debug-message');
          const debugContent = document.getElementById('debug-content');
          
          if (!debugBox || !debugContent) {
            console.warn('Debug message elements not found');
            return;
          }
          
          debugContent.textContent = message;
          debugBox.classList?.remove('hidden');
        }
        
        // Function to update last saved time display
        function updateLastSavedTime() {
          const lastSavedElement = document.getElementById('last-saved-time');
          if (!lastSavedElement) {
            console.warn('Last saved time element not found');
            return;
          }
          
          const lastSavedTime = localStorage.getItem('lastSavedTime');
          if (lastSavedTime) {
            lastSavedElement.textContent = new Date(lastSavedTime).toLocaleString();
          } else {
            lastSavedElement.textContent = 'Never';
          }
        }
        
        // Load settings from localStorage
        function loadSavedSettings() {
          const channelInput = document.getElementById('thingspeak-channel');
          const apiInput = document.getElementById('thingspeak-api-key');
          
          const channelID = localStorage.getItem('thingspeakChannelID');
          const apiKey = localStorage.getItem('thingspeakAPIKey');
          
          if (channelID && channelInput) {
            channelInput.value = channelID;
          }
          
          if (apiKey && apiInput) {
            apiInput.value = apiKey;
          }
          
          updateLastSavedTime();
        }
        
        // Setup test button
        const testButton = document.getElementById('test-localstorage-btn');
        if (testButton) {
          testButton.addEventListener('click', function() {
            checkLocalStorage();
            
            // Test save functionality directly
            try {
              localStorage.setItem('test_save', new Date().toISOString());
              showDebugMessage('Test save successful. Value: ' + localStorage.getItem('test_save'));
            } catch (e) {
              showDebugMessage('Test save failed: ' + e.message);
            }
          });
        }
        
        // Close debug message
        const closeDebug = document.getElementById('close-debug');
        if (closeDebug) {
          closeDebug.addEventListener('click', function() {
            const debugMsg = document.getElementById('debug-message');
            if (debugMsg) {
              debugMsg.classList?.add('hidden');
            }
          });
        }
        
        // Check storage on load
        checkLocalStorage();
        
        // Load saved settings
        loadSavedSettings();
      } catch (error) {
        console.error("Error during initialization:", error);
      }
    });
  </script>

  <!-- Add this at the end, right before the closing body tag -->
  <script>
    // ThingSpeak Debug Tool
    document.addEventListener('DOMContentLoaded', function() {
      // Set up example channel buttons
      document.querySelectorAll('.use-example-channel').forEach(button => {
        button.addEventListener('click', function() {
          const channelId = this.getAttribute('data-channel');
          const apiKey = this.getAttribute('data-key');
          
          document.getElementById('debug-channel-id').value = channelId;
          document.getElementById('debug-api-key').value = apiKey;
          
          // Optionally also set the main form values
          document.getElementById('thingspeak-channel').value = channelId;
          document.getElementById('thingspeak-api-key').value = apiKey;
          });
        });
      
      // Set up direct test button
      document.getElementById('test-thingspeak-direct').addEventListener('click', async function() {
        const resultsContainer = document.getElementById('debug-results-container');
        resultsContainer.innerHTML = '<div class="text-blue-400 text-sm"><i class="fas fa-circle-notch fa-spin mr-2"></i>Testing direct connection...</div>';
        
        const channelId = document.getElementById('debug-channel-id').value;
        const apiKey = document.getElementById('debug-api-key').value;
        const results = document.getElementById('debug-results').value || 1;
        
        if (!channelId || !apiKey) {
          resultsContainer.innerHTML = '<div class="text-red-400 text-sm">Please enter Channel ID and API Key.</div>';
          return;
        }
        
        try {
          // First make a very simple request to validate credentials
          const testUrl = `https://api.thingspeak.com/channels/${encodeURIComponent(channelId)}/feeds.json?api_key=${apiKey}&results=1`;
          
          const response = await fetch(testUrl, {
            method: 'GET',
            cache: 'no-cache',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            if (response.status === 404) {
              resultsContainer.innerHTML = `<div class="text-red-400 text-sm">Error: Channel not found (ID: ${channelId})</div>`;
            } else if (response.status === 401) {
              resultsContainer.innerHTML = `<div class="text-red-400 text-sm">Error: Invalid API key or you don't have permission to access this channel</div>`;
            } else {
              resultsContainer.innerHTML = `<div class="text-red-400 text-sm">HTTP error: ${response.status} ${response.statusText}</div>`;
            }
            return;
          }
          
          // Now fetch actual requested data
          const dataUrl = `https://api.thingspeak.com/channels/${encodeURIComponent(channelId)}/feeds.json?api_key=${apiKey}&results=${results}`;
          const dataResponse = await fetch(dataUrl);
          const data = await dataResponse.json();
          
          // Check if we have data
          if (!data || !data.channel) {
            resultsContainer.innerHTML = `<div class="text-red-400 text-sm">Invalid response from ThingSpeak API</div>`;
            return;
          }
          
          // Show channel info
          let html = `
            <div class="text-green-400 text-sm mb-2">✓ Connection successful!</div>
            <div class="mb-2">
              <div class="text-white text-sm font-medium">Channel Information:</div>
              <div class="text-gray-300 text-xs">Name: ${data.channel.name || 'Unnamed'}</div>
              <div class="text-gray-300 text-xs">Description: ${data.channel.description || 'No description'}</div>
              <div class="text-gray-300 text-xs">Created: ${new Date(data.channel.created_at).toLocaleString()}</div>
            </div>
            <div class="mb-2">
              <div class="text-white text-sm font-medium">Available Fields:</div>
              <div class="grid grid-cols-2 gap-1">
          `;
          
          // Add field info
          let fieldsFound = 0;
          for (let i = 1; i <= 8; i++) {
            const fieldKey = `field${i}`;
            if (data.channel[fieldKey]) {
              fieldsFound++;
              html += `<div class="text-gray-300 text-xs">${fieldKey}: ${data.channel[fieldKey]}</div>`;
            }
          }
          
          if (fieldsFound === 0) {
            html += `<div class="text-yellow-400 text-xs">No field definitions found!</div>`;
          }
          
          html += `
              </div>
            </div>
          `;
          
          // Add data info
          if (data.feeds && data.feeds.length > 0) {
            html += `
              <div class="mb-2">
                <div class="text-white text-sm font-medium">Data Points: ${data.feeds.length}</div>
                <div class="text-gray-300 text-xs">Latest: ${new Date(data.feeds[data.feeds.length-1].created_at).toLocaleString()}</div>
              </div>
            `;
            
            // Show sample of the latest data point
            const latest = data.feeds[data.feeds.length-1];
            html += `
              <div>
                <div class="text-white text-sm font-medium">Latest Values:</div>
                <div class="grid grid-cols-2 gap-1">
            `;
            
            let dataFound = false;
            for (let i = 1; i <= 8; i++) {
              const fieldKey = `field${i}`;
              if (latest[fieldKey] !== undefined) {
                dataFound = true;
                html += `<div class="text-gray-300 text-xs">${fieldKey}: ${latest[fieldKey]}</div>`;
              }
            }
            
            if (!dataFound) {
              html += `<div class="text-yellow-400 text-xs">No field data in the latest entry!</div>`;
            }
            
            html += `
                </div>
              </div>
            `;
            
          } else {
            html += `<div class="text-yellow-400 text-sm">No data points found in this channel!</div>`;
          }
          
          resultsContainer.innerHTML = html;
          
        } catch (error) {
          console.error("ThingSpeak debug test failed:", error);
          resultsContainer.innerHTML = `
            <div class="text-red-400 text-sm">Error: ${error.message}</div>
            <div class="text-yellow-400 text-xs mt-2">This may be a CORS issue if testing locally. Try the proxy option instead.</div>
          `;
        }
      });
      
      // Set up proxy test button
      document.getElementById('test-thingspeak-proxy').addEventListener('click', async function() {
        const resultsContainer = document.getElementById('debug-results-container');
        resultsContainer.innerHTML = '<div class="text-purple-400 text-sm"><i class="fas fa-circle-notch fa-spin mr-2"></i>Testing connection via proxy...</div>';
        
        const channelId = document.getElementById('debug-channel-id').value;
        const apiKey = document.getElementById('debug-api-key').value;
        const results = document.getElementById('debug-results').value || 1;
        
        if (!channelId || !apiKey) {
          resultsContainer.innerHTML = '<div class="text-red-400 text-sm">Please enter Channel ID and API Key.</div>';
          return;
        }
        
        try {
          // Use a CORS proxy service
          const proxyUrl = "https://cors-anywhere.herokuapp.com/";
          const targetUrl = `https://api.thingspeak.com/channels/${encodeURIComponent(channelId)}/feeds.json?api_key=${apiKey}&results=${results}`;
          
          // Note: The first time you use cors-anywhere, you'll need to visit https://cors-anywhere.herokuapp.com/
          // and request temporary access to the demo server
          
          const response = await fetch(proxyUrl + targetUrl, {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Origin': window.location.origin,
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            if (response.status === 403) {
              resultsContainer.innerHTML = `
                <div class="text-red-400 text-sm">Proxy access denied (403)</div>
                <div class="text-yellow-400 text-xs mt-2">You need to request temporary access to the CORS demo server at:</div>
                <div class="text-blue-400 text-xs">
                  <a href="https://cors-anywhere.herokuapp.com/" target="_blank" class="underline">https://cors-anywhere.herokuapp.com/</a>
                </div>
              `;
            } else if (response.status === 404) {
              resultsContainer.innerHTML = `<div class="text-red-400 text-sm">Error: Channel not found (ID: ${channelId})</div>`;
            } else if (response.status === 401) {
              resultsContainer.innerHTML = `<div class="text-red-400 text-sm">Error: Invalid API key</div>`;
            } else {
              resultsContainer.innerHTML = `<div class="text-red-400 text-sm">HTTP error: ${response.status} ${response.statusText}</div>`;
            }
            return;
          }
          
          const data = await response.json();
          
          // Display successful results (simplified version of the direct test)
          let html = `
            <div class="text-green-400 text-sm mb-2">✓ Proxy connection successful!</div>
            <div class="mb-2">
              <div class="text-white text-sm font-medium">Channel: ${data.channel?.name || 'Unnamed'}</div>
              <div class="text-gray-300 text-xs">Data Points: ${data.feeds?.length || 0}</div>
            </div>
          `;
          
          if (data.feeds && data.feeds.length > 0) {
            html += '<div class="text-white text-sm font-medium mt-2">Data sample:</div>';
            html += '<pre class="text-xs text-gray-300 bg-dark-800 p-2 rounded mt-1 overflow-x-auto">';
            html += JSON.stringify(data.feeds[0], null, 2);
            html += '</pre>';
          }
          
          resultsContainer.innerHTML = html;
          
        } catch (error) {
          console.error("ThingSpeak proxy test failed:", error);
          resultsContainer.innerHTML = `<div class="text-red-400 text-sm">Proxy Error: ${error.message}</div>`;
        }
        });
      });
  </script>

  <!-- Add this near the end of the file, before closing body tag but after including thingspeak-helper.js -->
  <script>
    // Set up ThingSpeak test connection
    document.addEventListener('DOMContentLoaded', function() {
      const testConnectionBtn = document.getElementById('test-connection');
      const connectionStatus = document.getElementById('connection-status');
      
      if (testConnectionBtn && connectionStatus) {
        testConnectionBtn.addEventListener('click', function() {
          const channelId = document.getElementById('thingspeak-channel')?.value;
          const apiKey = document.getElementById('thingspeak-api-key')?.value;
          
          if (!channelId || !apiKey) {
            connectionStatus.innerHTML = '<span class="text-red-500">Please enter Channel ID and API Key</span>';
            return;
          }
          
          connectionStatus.innerHTML = '<span class="text-blue-400"><i class="fas fa-circle-notch fa-spin mr-2"></i>Testing...</span>';
          
          // Wait for thingSpeakHelper to be initialized
          if (window.thingSpeakHelper) {
            window.thingSpeakHelper.testConnection({
              channelId,
              apiKey,
              resultContainer: connectionStatus
            });
          } else {
            // Fallback if helper is not loaded
            try {
              fetch(`https://api.thingspeak.com/channels/${encodeURIComponent(channelId)}/feeds.json?api_key=${apiKey}&results=1`)
                .then(response => {
                  if (!response.ok) {
                    connectionStatus.innerHTML = '<span class="text-red-500">Connection failed</span>';
                    return;
                  }
                  return response.json();
                })
                .then(data => {
                  if (data && data.channel) {
                    connectionStatus.innerHTML = '<span class="text-green-500">Connection successful!</span>';
                  } else {
                    connectionStatus.innerHTML = '<span class="text-red-500">Invalid response</span>';
                  }
                })
                .catch(error => {
                  connectionStatus.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
                });
            } catch (error) {
              connectionStatus.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            }
          }
        });
      }
    });
  </script>
</body>
</html> 